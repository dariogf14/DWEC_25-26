<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="/styles.css" />
  <title><%= libro.titulo %></title>
</head>
<body>
  <p>
    <a href="/">‚¨Ö Volver al cat√°logo</a> |
    <a href="/prestados">Prestados</a> |
    <a href="/vencidos">Vencidos</a>
  </p>

  <h1><%= libro.titulo %></h1>

  <ul>
    <li><strong>Autor:</strong> <%= libro.autor %></li>
    <li><strong>ISBN:</strong> <%= libro.isbn || "-" %></li>
    <li><strong>Estado:</strong> <%= libro.estado %></li>
  </ul>

  <hr/>

  <h2>Acciones</h2>

  <% if (libro.estado === "Disponible") { %>
    <p>El libro est√° disponible.</p>
    <a class="btn" href="/prestamo/formulario/<%= libro.id %>">Prestar Libro</a>
  <% } else { %>
    <p>üìå El libro est√° prestado.</p>

    <% if (prestamoActivo) { %>
      <p><strong>Prestado a:</strong> <%= prestamoActivo.nombre_prestatario %></p>
      <p><strong>Vence:</strong> <%= prestamoActivo.fecha_devolucion.toISOString().slice(0,10) %></p>

      <form method="POST" action="/prestamo/devolver/<%= libro.id %>">
        <button class="btn" type="submit">Registrar Devoluci√≥n</button>
      </form>
    <% } else { %>
      <p style="color:#b00"><strong>Ojo:</strong> Estado ‚ÄúPrestado‚Äù pero no hay pr√©stamo activo (datos inconsistentes).</p>
    <% } %>
  <% } %>

  <hr/>

  <h2>Historial de pr√©stamos</h2>

  <% if (historial.length === 0) { %>
    <p>No hay pr√©stamos registrados para este libro.</p>
  <% } else { %>
    <table>
      <thead>
        <tr>
          <th>Prestatario</th>
          <th>Fecha pr√©stamo</th>
          <th>Fecha devoluci√≥n</th>
          <th>Fecha entrega</th>
        </tr>
      </thead>
      <tbody>
        <% historial.forEach(h => { %>
          <tr>
            <td><%= h.nombre_prestatario %></td>
            <td><%= h.fecha_prestamo.toISOString().slice(0,10) %></td>
            <td><%= h.fecha_devolucion.toISOString().slice(0,10) %></td>
            <td>
              <% if (h.fecha_entrega) { %>
                <%= h.fecha_entrega.toISOString().slice(0,10) %>
              <% } else { %>
                <em>En curso</em>
              <% } %>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  <% } %>
</body>
</html>